---
title: 深入理解RunLoop  | Coder Bruce
date: 2020-02-22 10:35:43
permalink: /pages/b1af5cb8996363c5
categories: 
  - 前端
  - JavaScript文章
tags: 
  - null
author: 
  name: Coder Bruce
  link: https://bruceyou.notion.site/Coder-Bruce-5a8c1717a6d048b9bcaadf95281f1159
---
# 深入理解RunLoop  | Coder Bruce

## 什么是RunLoop？

RunLoop是iOS和macOS中的一个关键组件，用于处理事件、定时器和输入源的循环执行。它是一个事件循环，可以让我们的应用程序在空闲时保持静止，同时等待输入源的到来。

## RunLoop的运行模式

RunLoop可以运行在不同的模式下，每个模式都有不同的输入源集合，可以让我们控制RunLoop的行为。iOS和macOS中默认的RunLoop模式是Default Mode，它会处理大多数的输入源，包括UI事件和定时器事件。

除了默认模式之外，RunLoop还有其他几种模式，如Common Modes、Tracking Mode和Connection Mode等。我们可以通过切换RunLoop的模式来控制输入源的优先级和RunLoop的行为。

## RunLoop和多线程

每个线程都有一个与之相关联的RunLoop，它可以让线程在空闲时保持静止，等待输入源的到来。RunLoop是线程安全的，可以在多个线程中使用，但是每个RunLoop只能在一个线程中运行。

iOS和macOS中默认的RunLoop是主线程的RunLoop，因此在主线程中执行UI操作是安全的。在其他线程中执行UI操作时，我们需要手动切换到主线程中执行，这可以通过`performSelectorOnMainThread`、`DispatchQueue.main.async`等方式实现。

## RunLoop和性能优化

RunLoop是iOS和macOS中性能优化的关键组件之一，可以帮助我们优化应用程序的性能和响应速度。一些常见的性能优化技巧包括：

- 使用定时器代替循环：使用定时器可以避免循环等待的情况，从而提高应用程序的响应速度。
- 避免阻塞主线程：长时间的计算或I/O操作会阻塞主线程，导致应用程序无法响应用户的操作。可以通过将这些操作放到其他线程中执行，或使用异步调用的方式来避免这种情况。
- 禁用RunLoop触发的自动释放池：默认情况下，RunLoop会在每次循环结束时自动释放内存池，但是这会导致频繁的内存分配和回收。可以通过禁用RunLoop触发的自动释放池来提高性能。

## Apple官方文档

苹果官方文档提供了详细的关于RunLoop的介绍和使用方法，包括RunLoop的基本概念、运行模式、输入源和定时器等内容。

可以通过以下链接查看官方文档：

- [RunLoop Programming Guide](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html)（英文版）

  



## RunLoop的应用场景

RunLoop的应用场景非常广泛，常用于以下几个方面：

### UI事件处理

RunLoop是iOS和macOS中处理UI事件的关键组件之一。当用户在界面上操作时，UI事件会被发送到RunLoop中，然后由RunLoop将事件分发给对应的UI控件进行处理。

### 网络通信

RunLoop还常用于网络通信中，可以使用输入源来监听网络套接字，当有数据到达时，RunLoop会通知应用程序进行处理。

### 定时器

RunLoop还支持定时器的创建和管理，可以使用定时器来实现周期性的操作，例如轮询数据、定时更新UI等。

### 性能优化

RunLoop是iOS和macOS中性能优化的关键组件之一，可以帮助我们优化应用程序的性能和响应速度。通过合理地使用RunLoop，可以避免频繁的CPU调度和内存分配等问题，从而提高应用程序的性能。

## 发明人和权威人士

RunLoop最初是由苹果公司的Scott Forstall设计和实现的。在Scott Forstall之后，RunLoop的开发和维护工作一直由苹果公司的核心开发团队负责，包括Darren Duh、Dave DeLong等人。

在iOS和macOS开发中，RunLoop的使用非常广泛，因此关于RunLoop的文章和教程也非常丰富。Dave DeLong在其博客中写了一系列关于RunLoop的文章，其中包括[Understanding the NSRunLoop](https://davedelong.com/blog/2018/05/09/understanding-nsrunloop/)、[RunLoop Part 1: What is a Run Loop?](https://davedelong.com/blog/2018/05/15/what-is-a-run-loop/)等内容，深入浅出地介绍了RunLoop的基本概念和运行原理。

RunLoop的本质就是 event loop?







是的，RunLoop的本质就是一个事件循环（event loop）。RunLoop会不断地从输入源（input source）中获取事件，并将事件分发给对应的处理器进行处理，然后等待下一个事件到来。这个过程就像一个循环一样，不断地重复执行，直到RunLoop被停止或者应用程序退出。

在iOS和macOS中，RunLoop是非常重要的一个组件，它负责管理各种事件，包括用户输入事件、定时器事件、网络事件等等。RunLoop的设计目的是为了提高应用程序的响应速度和性能，避免不必要的CPU和内存占用。

除了iOS和macOS之外，其他操作系统也都有类似的事件循环机制，例如Windows中的消息循环（message loop），Linux中的事件循环（event loop）等等。不同的操作系统可能会有一些细节上的差异，但它们的基本原理都是类似的，都是通过事件循环来管理各种事件。





计算机中的事件循环（event loop）发展历史  谁发的买的 第一个 事件循环（event loop）是谁写的  代码示例(用中文注释)







计算机中的事件循环（event loop）起源于早期的操作系统和编程语言，具体发展历史如下：

1. 早期的操作系统，例如Unix和DOS，提供了基本的事件循环机制，用于管理用户输入和输出、文件读写、进程调度等操作。
2. 随着GUI界面的兴起，事件循环机制变得越来越重要。早期的GUI框架（例如X Window和Motif）都提供了自己的事件循环机制，用于管理鼠标、键盘和窗口等事件。
3. 1987年，Doug Crockford在他的论文《Application Software Development: A Discipline of Software Design》中提出了JavaScript的前身——LiveScript，并首次引入了事件循环的概念。LiveScript后来演变为JavaScript，并成为了Web开发中的主流编程语言。
4. 在Web开发中，事件循环机制被广泛应用于浏览器和服务器端的开发。在浏览器中，事件循环机制用于管理用户输入和DOM事件等，而在服务器端，事件循环机制则用于管理网络通信和异步IO操作等。
5. 随着Node.js的兴起，事件循环机制在服务器端的开发中变得越来越重要。Node.js的事件循环机制基于libuv库实现，可以同时处理大量的并发连接和异步IO操作。

目前，事件循环机制已经成为计算机编程中不可或缺的一部分，被广泛应用于各种类型的应用程序中。

第一个事件循环（event loop）的实现可能很难追溯，因为它可能是在早期的操作系统或编程语言中被实现的。但是，Doug Crockford在他的论文中首次引入了事件循环的概念，因此可以说他是第一个引入事件循环概念的人之一。

下面是一个使用JavaScript实现事件循环的示例代码，注释中解释了代码的执行过程：

```
javascriptCopy code
// 创建一个事件队列
let eventQueue = [];

// 向事件队列中添加事件
eventQueue.push(() => {
  console.log('第一个事件');
});

eventQueue.push(() => {
  console.log('第二个事件');
});

eventQueue.push(() => {
  console.log('第三个事件');
});

// 定义一个事件循环函数
function eventLoop() {
  // 如果事件队列不为空，则取出队首的事件并执行
  while (eventQueue.length > 0) {
    let event = eventQueue.shift();
    event();
  }
}

// 启动事件循环
eventLoop();
```

上面的代码创建了一个事件队列，并向其中添加了三个事件。然后定义了一个事件循环函数，不断地从事件队列中取出事件并执行。最后调用了
